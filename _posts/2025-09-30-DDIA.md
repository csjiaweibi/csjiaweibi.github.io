---
title: '数据密集型系统应用设计'
date: 2025-09-30
permalink: /posts/2025/04/blog-post-6/
tags:
  - 分布式原理
---

这篇博客将分享一些我在学习分布式数据库中的学习心得。

👉 [我的项目链接](https://github.com/csjiaweibi/DDIA)

---

## CAP 理论
任何一个分布数据复制系统都无法同时满足 **强数据一致性（Consistency）**、**可用性（Availability）** 及 **网络分区容忍性（Partition Tolerance）** 三种特性。

参考书籍：《Designing Data-Intensive Applications (DDIA)》

---

## 常见的数据系统
- **数据库**：存储数据，以便之后再次使用  
- **缓存**：记住一些非常重的操作结果，方便之后加快读取速度  
- **搜索引擎**：允许用户以各种关键字搜索、以各种条件过滤数据  
- **流式处理**：源源不断地产生数据，并发送给其他进程进行处理  
- **批处理**：定期处理累积的大量数据  
- **消息队列**：进行消息的传送与分发  

### 设计时常见问题
- 使用何种缓存策略？是旁路还是写穿透？  
- 部分组件机器出现问题时，是保证可用性还是保证一致性？  
- 当机器一时难以恢复，如何保证数据的正确性和完整性？  
- 当负载增加时，是增加机器还是提升单机性能？  
- 设计对外的 API 时，是力求简洁还是追求强大？  

---

## 系统特性

### 可靠性（Reliability）
系统在困境（硬件故障、软件故障、人为错误）中仍可正常工作（正确完成功能，并能达到期望的性能水准）。

- **MTTF** (Mean Time To Failure)：  
  单块硬盘平均故障时间 5 ~ 10 年。  
  如果有 1w+ 硬盘，均匀期望下，每天都有坏盘出现。  
  事实上，硬盘往往会“成批”坏。

### 可扩展性（Scalability）
有合理的办法应对系统的增长（数据量、流量、复杂性）。

### 可维护性（Maintainability）
许多不同的人（工程师、运维）在不同的生命周期，都能高效地在系统上工作（保持现有行为，并适应新的应用场景）。

---

## 基础理论
- **CAP 理论**
- **原子操作**：不可中断的一系列操作，不会被线程调度打断，运行期间不会有任何上下文切换（context switch）。

---

## 分布式事务

### 协议
1. **两段提交协议（2PC）**  
2. **三段提交协议（3PC）**

---

## 数据分片（Sharding）
为了在多个节点上存储数据，需要将数据分片（分区）。

### 常见分片算法
- **一致性哈希（Consistent Hashing）**  
  节点变化时最小化重新分片的数据量，适合动态扩展和收缩。  
- **范围分片（Range Sharding）**  
  按键范围分片，例如 a-m 存储在一个节点，n-z 存储在另一个节点。  

### 网络通信
- **HTTP/REST**：简单 API 传输请求  
- **gRPC**：高效二进制协议，适合高性能应用  

### 数据复制策略
- **主从复制（Master-Slave Replication）**：主节点负责写，从节点负责读  
- **多主复制（Multi-Master Replication）**：多个主节点可读写，数据在节点间传播  
- **最终一致性（Eventual Consistency）**：最终副本一致，短期可能不一致  
- **强一致性（Strong Consistency）**：所有读返回最近写入结果  

### 节点健康与恢复
- **心跳检测**：定期检测节点存活  
- **节点恢复**：重启后需从其他节点同步数据  

> 生产级分布式 KV 系统（如 Etcd、Consul、Redis Cluster）还涉及分布式事务、快照、持久化等优化。

---

## 并发
- **并发**：多个计算机节点共享资源，整体性能随资源增加而提高  
- **缺乏全局时钟**：协作依赖消息交换，但网络时间同步有限  
- **故障独立性**：  
  - 网络故障 → 节点隔离  
  - 程序无法区分“网络故障”还是“延迟过高”  
  - 节点崩溃或异常终止 → 其他组件不一定立即感知  

---

## 通信
- **RPC**：目标是屏蔽网络不可靠性  
- **线程**：提供结构化的并发操作  
  - **锁（Lock）**：常见的并发控制机制  

---

## 一致性模型

### 强一致性
- 数据更新后，后续读一定返回最新值  
- 实现代价高，需要大量通信  
- 延迟较大，跨地域副本开销更大  

### 弱一致性
- 数据更新后，不能保证读到最新值  
- 延迟低，响应更快  
- 通常通过额外规则（如会话一致性、单调一致性）增强实际意义  

---
