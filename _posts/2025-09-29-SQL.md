---
title: 'SQL'
date: 2025-09-29
permalink: /posts/2025/04/blog-post-4/
tags:
  - 日志
  - 锁
---

👉 [我的项目链接](https://github.com/csjiaweibi/DDIA)
:这个项目将会分享我阅读源码时候的心得体会


## MySQL


数据库连接池

## 语法

### 三大范式
1. **第一范式**：将列尽可能最小分割，避免单列存多个值的冗余。  
2. **第二范式**：要求唯一主键，不存在对主键的部分依赖，消除冗余列。  
3. **第三范式**：没有间接依赖于主键的列，进一步消除冗余。

### SQL 语句执行顺序
1. **连接**：查询缓存 → 分析 → 预处理 → 优化 → 执行  
2. **顺序**：
   - `FROM + JOIN`：确定查询的表  
   - `WHERE`：条件过滤  
   - `GROUP BY`：分组  
   - 聚合函数（`COUNT()`, `SUM()`, `AVG()` …）在 `GROUP BY` 之后、`HAVING` 之前执行  
   - `HAVING`：分组过滤  
   - `SELECT`：选择列  
   - `DISTINCT`：去重  
   - `ORDER BY`：排序  
   - `LIMIT/OFFSET`：限制行数  

## 架构

### 服务层
- 内置函数 & 跨存储引擎功能  

### 连接器
- 建立连接、管理连接、校验身份  

### 查询缓存
- 检查是否存在缓存结果  

### 解析器
- 语法分析，构建语法树  
- 方便提取表名、字段、语句类型  

### SQL 执行
1. **预处理阶段**：检查表或字段是否存在  
2. **优化阶段**：选择索引，制定最优查询方案  
3. **执行阶段**：从存储引擎读取数据并返回  
   - 主键索引查询  
   - 全表扫描  
   - 索引下推 

## 存储引擎

### 存储结构
表空间由 **段（segment）→ 区（extent）→ 页（page）→ 行（row）** 组成。

### 常见引擎
- **InnoDB**：事务、行级锁、崩溃恢复、MVCC，高并发场景。  
- **MyISAM**：无事务，读操作频繁时性能强，表级锁，支持全文索引。  
- **MEMORY**：内存存储，速度快，重启丢失。  
- **ARCHIVE**：适合历史数据，支持压缩，不支持更新删除。  
- **CSV**：轻量级数据交换，存储为 CSV 格式。  

### InnoDB 数据页结构
- 每页 16KB（去除页头页尾约 200B）  
- B+ 树索引：前两层存索引，第三层存实际数据  

### Buffer Pool
- 读：通过 buffer pool 提升效率  
- 写：通过 change buffer 提升效率  

### Redo Log Buffer
- 提供持久化保障  



## 日志系统
MySQL 日志确保 **持久性 & 一致性**。

- **Redo Log（重做日志）**：保证事务持久性  
- **Undo Log（撤销日志）**：支持事务回滚 & MVCC  
- **Binary Log（二进制日志，Binlog）**：记录所有更改操作  
  - **应用场景**：数据恢复、主从复制、数据审计  
  - **方法**：
    - 增量备份：结合全量备份 + Binlog  
    - 时间点恢复：恢复至误操作之前  


## 事务

### ACID
- **原子性**：由 Undo Log 实现  
- **一致性**：Undo Log + Redo Log + 隔离性  
- **隔离性**：锁机制 & MVCC  
- **持久性**：由 Redo Log 实现  

### 隔离级别
1. **读未提交（Read Uncommitted）**  
   - 脏读、幻读、不可重复读  
2. **读已提交（Read Committed）**  
   - 避免脏读，但仍有不可重复读、幻读  
3. **可重复读（Repeatable Read，MySQL 默认）**  
   - 通过 MVCC & next-key lock 避免幻读  
   - 普通读 = 快照读（不加锁），当前读需加锁  
4. **串行化（Serializable）**  
   - 完全基于锁，性能最低  


## MVCC

### 组成
- **trx_id**：事务 ID  
- **roll_pointer**：回滚指针，指向 Undo Log  
- **ReadView**：快照视图，决定可见性  

### ReadView 判断规则
1. 事务 ID = 当前事务 → 可见  
2. 事务 ID < 最小活跃事务 → 已提交，可见  
3. 事务 ID > max_trx_id → 不可见  
4. 若事务 ID 不在活跃列表 → 可见  

### RC 与 RR 的差异
- **RC**：每次查询新建 ReadView  
- **RR**：整个事务共享同一个 ReadView  

### 幻读
- **快照读**：RR 级别避免幻读  
- **当前读**：RR 级别用 next-key lock 避免幻读  

---

## 索引

### 索引类型
- **覆盖索引**：查询列都在索引中，避免回表  
- **全文索引**：倒排索引，适合大文本搜索  
- **前缀索引**：对长文本字段索引，减少空间  
- **组合索引**：多列索引，遵循最左前缀原则  
- **主键索引**：聚簇索引，叶子节点存储整行数据  
- **普通索引**：非聚簇索引，叶子节点存储主键值  

---

## 锁

### 锁类型
- **意向锁**：表明事务意图  
- **插入意向锁**：新行插入意图  
- **排他锁（X 锁）**：如 `FOR UPDATE`，防止并发写  
- **共享锁（S 锁）**：允许读，不允许写  
- **乐观锁 / 悲观锁**  
- **快照读 / 当前读**  
- **行锁**：
  - Record Lock（记录锁）  
  - Gap Lock（间隙锁）  
  - Next-Key Lock（记录锁 + 间隙锁）  

---

## 数据问题
- 单表 > 500 万行或 > 2GB → 建议分库分表  
- **数据倾斜**：热点数据处理  
- **数据迁移**：方便管理、降低成本  

---

## 工具

### JDBC
- 标准 API：连接数据库、执行 SQL、事务管理  
- 组件：`DriverManager`、`Statement`、`ResultSet`  

### ORM
- **SQLBuilder**：链式构造 SQL  
- **Scanner**：自动映射数据到结构体  

---

## 案例分析

### 慢查询优化
1. **捕获低效 SQL**：启用 `slow_query_log`  
2. **分析日志**：用 `mysqldumpslow` 等工具  
3. **执行计划分析**：`EXPLAIN`  
4. **优化方法**：
   - 索引优化  
   - 查询优化（减少列、分页查询、JOIN 替代子查询）  
   - 数据库配置优化（缓冲区、临时表大小等）  
   - 架构优化（分库分表、读写分离）  
   - 硬件升级（SSD、内存、CPU）  

### 连接池
- 避免频繁创建/销毁连接  
- 常用实现：**HikariCP**（默认）、**Druid**（功能强大）  

### 分库分表、读写分离
- 主从复制 + 两阶段提交  

---

